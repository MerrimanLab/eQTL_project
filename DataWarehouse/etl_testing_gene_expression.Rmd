---
title: "ETL_GeneExpression"
author: "Nick Burns"
date: "28 June 2016"
output: html_document
---

## Incorporating Gene Expression data into the eQTL data warehouse  

By themselves, eQTLs are not amazingly informative. Here, we will add the gene expression summary data from GTEx to enrichen the information in the data warehouse. Nicely, GTEx have already mapped the EnsemblIDs to gene names in the gene expression dataset, so this will become the template for dimGene. the plan:  

  1. to prepare the gene expression data.  
    - read it & have a quick look
    - recode sample names to include tissues  
    - melt the dataset for easier loading into the data warehouse  
    - save to disk for loading into data warehouse
    
    NOTE: the following steps will be tested here before being wrapped into the full ETL script.
  2. create a staging table in the data warehouse  
  3. bulk load the gene expression data  
  4. populate dimGene (and dimTissue?)  
  5. populate factExpression  
  
```{r}
setwd("~/Documents/GitHub/eQTL_project/DataWarehouse/")
library(data.table)

expression <- fread("/mnt/DataDrive/gEXPR_eQTL_Datasets/GTEXData/GeneExpression/All_Tissue_Site_Details_Analysis.combined.rpkm.gct")

# metadata: includes information about the naming convention of samples (columns)
meta <- fread("/mnt/DataDrive/gEXPR_eQTL_Datasets/GTEXData/Metadata/GTEx_Data_V6_Annotations_SampleAttributesDS.txt")
meta <- meta[, .(SAMPID, SMTS, SMTSD)]

# pheno: I haven't looked at this previously, well worth a look I think
pheno <- fread("/mnt/DataDrive/gEXPR_eQTL_Datasets/GTEXData/Metadata/GTEx_Data_V6_Annotations_SubjectPhenotypesDS.txt")

lapply(list(expression, meta, pheno), dim)
```

The expression dataset contains 56,318 rows (genes) with expression counts (RPKM) over 8557 samples. The sample naming conventions are described in the meta data file, these include information (SMTS and SMTSD) on which tissues these samples were drawn from. Looking at the head of pheno, this isn't going to be much use to us at all, with only gender and age.

## Recode to include tissue information  

For this, we will first melt the dataset and then add a column with the tissue names. We will include both SMTS (broad tissue categories) and SMTSD (specific tissue categories).

```{r}
gtex <- melt(expression, id.vars = c("Name", "Description"))
head(gtex)
dim(gtex)

rm(expression)
rm(pheno)

write.csv(gtex, "/mnt/DataDrive/gEXPR_eQTL_Datasets/GTEXData/GeneExpression/gtex_expression.csv", row.names = FALSE)
write.csv(meta[, .(SAMPID, SMTS, SMTSD)], "/mnt/DataDrive/gEXPR_eQTL_Datasets/GTEXData/GeneExpression/gtex_metadata.csv", row.names = FALSE)
```

Thank goodness for data.table :) The gtex variable is now quite large, 4 columns but 48 million rows. Have tried, and there is no hope of merging this with the meta data in R. Therefore, will push both the expression table and the metadata into the data warehouse and perform this join there. Even then, this is going to be a tough task - the csv file is 30 GB.

Tried using AWK to create smaller files, say of 10 million rows. But this was horribly horribly slow. I am assuming it had to lift hte entire 30 GB file each time. Am now resorting to using RMySQL, and will batch out the inserts.

```{r}
library(RMySQL)
library(data.table)
setwd("/mnt/DataDrive/gEXPR_eQTL_Datasets/GTEXData/GeneExpression/")

gtex <- fread("gtex_expression.csv")
colnames(gtex) <- c("ensembl_id", "gene_symbol", "sample_id", "rpkm")

drv <- DBI::dbDriver('MySQL')
conn <- RMySQL::dbConnect(drv, dbname = 'test_bulk_load', user = "root", password = ")OKM9ijn")

chunk_size <- nrow(gtex) %/% 100
for (i in 0:100) {
    
    start_row <- i * chunk_size + 1
    end_row <- if (i == 100) start_row + (nrow(gtex) - start_row)
               else start_row + chunk_size - 1
    
    print(sprintf("---- Beginning %s:%s-%s   %s ----", i, start_row, end_row, Sys.time()))
    
    dbWriteTable(conn, "expression_staging", gtex[start_row:end_row], row.names = FALSE, append = TRUE)
}

dbDisconnect(conn)

```